{% extends "base.html" %}

{% block title %}Dashboard - Crypto Forecast{% endblock %}
{% block nav_dashboard %}active{% endblock %}

{% block content %}
<div class="page-title">Dashboard</div>
<div class="page-subtitle">Welcome back, {{ current_user.username }}. Here's your portfolio overview.</div>

<!-- Statistics Cards -->
<div class="stat-grid">
    <div class="stat-card accent animate-in">
        <div class="stat-label"><i class="fas fa-chart-line"></i> Total Predictions</div>
        <div class="stat-value" id="total-predictions">0</div>
    </div>
    <div class="stat-card success animate-in">
        <div class="stat-label"><i class="fas fa-brain"></i> Models Trained</div>
        <div class="stat-value" id="models-trained">0</div>
    </div>
    <div class="stat-card info animate-in">
        <div class="stat-label"><i class="fas fa-coins"></i> Coins with Models</div>
        <div class="stat-value" id="coins-with-models">0</div>
    </div>
    <div class="stat-card warning animate-in">
        <div class="stat-label"><i class="fas fa-percentage"></i> Success Rate</div>
        <div class="stat-value" id="success-rate">0%</div>
    </div>
</div>

<!-- Market Data -->
<div class="cf-card animate-in" style="margin-bottom: 24px;">
    <div class="cf-card-header">
        <h3><i class="fas fa-chart-area" style="margin-right:8px; color:var(--accent);"></i> Market Data</h3>
        <span class="cf-badge neutral" id="data-status">
            <span class="status-dot loading"></span> Loading
        </span>
    </div>
    <div class="cf-card-body" style="padding:0;">
        <div style="overflow-x:auto;">
            <table class="cf-table" id="market-table">
                <thead>
                    <tr>
                        <th>Coin</th>
                        <th>Price</th>
                        <th>Market Cap</th>
                        <th>24h Change</th>
                        <th>Volume</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="market-data">
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading market data...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Prediction + Training Row -->
<div class="row g-4 mb-4">
    <!-- Prediction Section -->
    <div class="col-lg-6">
        <div class="cf-card animate-in" style="height:100%;">
            <div class="cf-card-header">
                <h3><i class="fas fa-chart-line" style="margin-right:8px; color:var(--accent);"></i> Generate Prediction</h3>
            </div>
            <div class="cf-card-body">
                <form id="prediction-form">
                    <div style="margin-bottom:16px;">
                        <label class="cf-label">Select Coin</label>
                        <select class="cf-select" id="coin-select">
                            <option value="">Choose a coin...</option>
                            {% for coin in coins %}
                            <option value="{{ coin }}"
                                {% if coin in coins_with_models %}data-has-model="true"{% endif %}>
                                {{ coin }} {% if coin in coins_with_models %}✓ Model Ready{% else %}— No Model{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label class="cf-label">Prediction Type</label>
                        <select class="cf-select" id="prediction-type">
                            <option value="price">Price</option>
                            <option value="market_cap">Market Cap</option>
                            <option value="all">Both (Price + Market Cap)</option>
                        </select>
                    </div>
                    <button type="submit" class="cf-btn primary full" id="predict-btn">
                        <i class="fas fa-chart-line"></i> Generate Prediction
                    </button>
                </form>
                <div id="prediction-result" style="margin-top:16px;"></div>
            </div>
        </div>
    </div>

    <!-- Prediction Meter + Quick Train -->
    <div class="col-lg-6">
        <div class="cf-card animate-in" style="height:100%;">
            <div class="cf-card-header">
                <h3><i class="fas fa-brain" style="margin-right:8px; color:var(--success);"></i> Quick Train</h3>
            </div>
            <div class="cf-card-body">
                <form id="training-form">
                    <div style="margin-bottom:16px;">
                        <label class="cf-label">Select Coin(s)</label>
                        <select class="cf-select" id="train-coin-select" multiple size="4">
                            {% for coin in coins %}
                            <option value="{{ coin }}">{{ coin }}</option>
                            {% endfor %}
                        </select>
                        <small style="color:var(--text-muted);font-size:12px;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label class="cf-label">Model Type</label>
                        <select class="cf-select" id="model-type">
                            <option value="ensemble">Ensemble (XGBoost + LightGBM)</option>
                            <option value="xgboost">XGBoost Only</option>
                            <option value="lightgbm">LightGBM Only</option>
                        </select>
                    </div>
                    <label class="cf-checkbox" style="margin-bottom:20px;">
                        <input type="checkbox" id="skip-ingestion">
                        Skip data download (use existing data)
                    </label>
                    <button type="submit" class="cf-btn success full" id="train-btn">
                        <i class="fas fa-play"></i> Start Training Pipeline
                    </button>
                </form>
                <div id="training-status" style="margin-top:16px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Predictions -->
<div class="cf-card animate-in">
    <div class="cf-card-header">
        <h3><i class="fas fa-history" style="margin-right:8px; color:var(--text-muted);"></i> Recent Predictions</h3>
    </div>
    <div class="cf-card-body" style="padding:0;">
        <div style="overflow-x:auto;">
            <table class="cf-table" id="recent-predictions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Coin</th>
                        <th>Type</th>
                        <th>Horizon</th>
                        <th>Current</th>
                        <th>Predicted</th>
                        <th>Change</th>
                    </tr>
                </thead>
                <tbody id="recent-predictions">
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <p>No predictions yet. Generate your first prediction above.</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- WebSocket Status -->
<div class="ws-status" id="websocket-status">
    <span class="status-dot offline"></span> Disconnected
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}